mw.loader.implement("mediawiki.api@nli0d",function($,jQuery,require,module){(function(){var defaultOptions={parameters:{action:'query',format:'json'},ajax:{url:mw.util.wikiScript('api'),timeout:30*1000,dataType:'json'}},promises={};function mapLegacyToken(action){var csrfActions=['edit','delete','protect','move','block','unblock','email','import','options'];if(csrfActions.indexOf(action)!==-1){mw.track('mw.deprecate','apitoken_'+action);mw.log.warn('Use of the "'+action+'" token is deprecated. Use "csrf" instead.');return'csrf';}return action;}promises[defaultOptions.ajax.url]={};$.each(mw.user.tokens.get(),function(key,value){promises[defaultOptions.ajax.url][key]=$.Deferred().resolve(value).promise({abort:function(){}});});mw.Api=function(options){var defaults=$.extend({},options),setsUrl=options&&options.ajax&&options.ajax.url!==undefined;defaults.parameters=$.extend({},defaultOptions.parameters,defaults.parameters);defaults.ajax=$.extend({},defaultOptions.ajax,defaults.ajax);if(
setsUrl){defaults.ajax.url=String(defaults.ajax.url);}if(defaults.useUS===undefined){defaults.useUS=!setsUrl;}this.defaults=defaults;this.requests=[];};mw.Api.prototype={abort:function(){this.requests.forEach(function(request){if(request){request.abort();}});},get:function(parameters,ajaxOptions){ajaxOptions=ajaxOptions||{};ajaxOptions.type='GET';return this.ajax(parameters,ajaxOptions);},post:function(parameters,ajaxOptions){ajaxOptions=ajaxOptions||{};ajaxOptions.type='POST';return this.ajax(parameters,ajaxOptions);},preprocessParameters:function(parameters,useUS){var key;for(key in parameters){if(Array.isArray(parameters[key])){if(!useUS||parameters[key].join('').indexOf('|')===-1){parameters[key]=parameters[key].join('|');}else{parameters[key]='\x1f'+parameters[key].join('\x1f');}}else if(parameters[key]===false||parameters[key]===undefined){delete parameters[key];}}},ajax:function(parameters,ajaxOptions){var token,requestIndex,api=this,apiDeferred=$.Deferred(),xhr,key,formData;
parameters=$.extend({},this.defaults.parameters,parameters);ajaxOptions=$.extend({},this.defaults.ajax,ajaxOptions);if(parameters.token){token=parameters.token;delete parameters.token;}this.preprocessParameters(parameters,this.defaults.useUS);if(ajaxOptions.type==='POST'&&window.FormData&&ajaxOptions.contentType==='multipart/form-data'){formData=new FormData();for(key in parameters){formData.append(key,parameters[key]);}if(token){formData.append('token',token);}ajaxOptions.data=formData;ajaxOptions.processData=!1;ajaxOptions.contentType=!1;}else{ajaxOptions.data=$.param(parameters);if(token){ajaxOptions.data+='&token='+encodeURIComponent(token);}ajaxOptions.data=ajaxOptions.data.replace(/\./g,'%2E');if(ajaxOptions.contentType==='multipart/form-data'){delete ajaxOptions.contentType;}}xhr=$.ajax(ajaxOptions).fail(function(xhr,textStatus,exception){apiDeferred.reject('http',{xhr:xhr,textStatus:textStatus,exception:exception});}).done(function(result,textStatus,jqXHR){var code;if(
result===undefined||result===null||result===''){apiDeferred.reject('ok-but-empty','OK response but empty result (check HTTP headers?)',result,jqXHR);}else if(result.error){code=result.error.code===undefined?'unknown':result.error.code;apiDeferred.reject(code,result,result,jqXHR);}else if(result.errors){code=result.errors[0].code===undefined?'unknown':result.errors[0].code;apiDeferred.reject(code,result,result,jqXHR);}else{apiDeferred.resolve(result,jqXHR);}});requestIndex=this.requests.length;this.requests.push(xhr);xhr.always(function(){api.requests[requestIndex]=null;});return apiDeferred.promise({abort:xhr.abort}).fail(function(code,details){if(!(code==='http'&&details&&details.textStatus==='abort')){mw.log('mw.Api error: ',code,details);}});},postWithToken:function(tokenType,params,ajaxOptions){var api=this,abortedPromise=$.Deferred().reject('http',{textStatus:'abort',exception:'abort'}).promise(),abortable,aborted;return api.getToken(tokenType,params.assert).then(function(token){
params.token=token;if(aborted){return abortedPromise;}return(abortable=api.post(params,ajaxOptions)).catch(function(code){if(code==='badtoken'){api.badToken(tokenType);params.token=undefined;abortable=null;return api.getToken(tokenType,params.assert).then(function(token){params.token=token;if(aborted){return abortedPromise;}return(abortable=api.post(params,ajaxOptions));});}return $.Deferred().rejectWith(this,arguments);});}).promise({abort:function(){if(abortable){abortable.abort();}else{aborted=!0;}}});},getToken:function(type,assert){var apiPromise,promiseGroup,d,reject;type=mapLegacyToken(type);promiseGroup=promises[this.defaults.ajax.url];d=promiseGroup&&promiseGroup[type+'Token'];if(!promiseGroup){promiseGroup=promises[this.defaults.ajax.url]={};}if(!d){apiPromise=this.get({action:'query',meta:'tokens',type:type,assert:assert});reject=function(){delete promiseGroup[type+'Token'];return $.Deferred().rejectWith(this,arguments);};d=apiPromise.then(function(res){if(!res.query){
return reject('query-missing',res);}if(!res.query.tokens[type+'token']){return $.Deferred().reject('token-missing',res);}return res.query.tokens[type+'token'];},reject).promise({abort:apiPromise.abort});promiseGroup[type+'Token']=d;}return d;},badToken:function(type){var promiseGroup=promises[this.defaults.ajax.url];type=mapLegacyToken(type);if(promiseGroup){delete promiseGroup[type+'Token'];}}};}());(function(){$.extend(mw.Api.prototype,{isCategory:function(title){var apiPromise=this.get({formatversion:2,prop:'categoryinfo',titles:[String(title)]});return apiPromise.then(function(data){return!!(data.query&&data.query.pages&&data.query.pages[0].categoryinfo);}).promise({abort:apiPromise.abort});},getCategoriesByPrefix:function(prefix){var apiPromise=this.get({formatversion:2,list:'allpages',apprefix:prefix,apnamespace:mw.config.get('wgNamespaceIds').category});return apiPromise.then(function(data){return data.query.allpages.map(function(category){return new mw.Title(category.title).
getMainText();});}).promise({abort:apiPromise.abort});},getCategories:function(title){var apiPromise=this.get({formatversion:2,prop:'categories',titles:[String(title)]});return apiPromise.then(function(data){var page;if(!data.query||!data.query.pages){return false;}page=data.query.pages[0];if(!page.categories){return false;}return page.categories.map(function(cat){return new mw.Title(cat.title);});}).promise({abort:apiPromise.abort});}});}());(function(){$.extend(mw.Api.prototype,{postWithEditToken:function(params,ajaxOptions){return this.postWithToken('csrf',params,ajaxOptions);},getEditToken:function(){return this.getToken('csrf');},create:function(title,params,content){return this.postWithEditToken($.extend({action:'edit',title:String(title),text:content,formatversion:'2',assert:mw.config.get('wgUserName')?'user':undefined,createonly:!0},params)).then(function(data){return data.edit;});},edit:function(title,transform){var basetimestamp,curtimestamp,api=this;title=String(title);
return api.get({action:'query',prop:'revisions',rvprop:['content','timestamp'],titles:[title],formatversion:'2',curtimestamp:!0}).then(function(data){var page,revision;if(!data.query||!data.query.pages){return $.Deferred().reject('unknown');}page=data.query.pages[0];if(!page||page.invalid){return $.Deferred().reject('invalidtitle');}if(page.missing){return $.Deferred().reject('nocreate-missing');}revision=page.revisions[0];basetimestamp=revision.timestamp;curtimestamp=data.curtimestamp;return transform({timestamp:revision.timestamp,content:revision.content});}).then(function(params){var editParams=typeof params==='object'?params:{text:String(params)};return api.postWithEditToken($.extend({action:'edit',title:title,formatversion:'2',assert:mw.config.get('wgUserName')?'user':undefined,basetimestamp:basetimestamp,starttimestamp:curtimestamp,nocreate:!0},editParams));}).then(function(data){return data.edit;});},newSection:function(title,header,message,additionalParams){return this.
postWithEditToken($.extend({action:'edit',section:'new',title:String(title),summary:header,text:message},additionalParams));}});}());(function(){'use strict';$.extend(mw.Api.prototype,{login:function(username,password){var params,apiPromise,innerPromise,api=this;params={action:'login',lgname:username,lgpassword:password};apiPromise=api.post(params);return apiPromise.then(function(data){params.lgtoken=data.login.token;innerPromise=api.post(params).then(function(data){var code;if(data.login.result!=='Success'){code=data.error&&data.error.code||'unknown';return $.Deferred().reject(code,data);}return data;});return innerPromise;}).promise({abort:function(){apiPromise.abort();if(innerPromise){innerPromise.abort();}}});}});}());(function(){'use strict';$.extend(mw.Api.prototype,{getMessages:function(messages,options){options=options||{};return this.get($.extend({action:'query',meta:'allmessages',ammessages:messages,amlang:mw.config.get('wgUserLanguage'),formatversion:2},options)).then(
function(data){var result={};data.query.allmessages.forEach(function(obj){if(!obj.missing){result[obj.name]=obj.content;}});return result;});},loadMessages:function(messages,options){return this.getMessages(messages,options).then(mw.messages.set.bind(mw.messages));},loadMessagesIfMissing:function(messages,options){var missing=messages.filter(function(msg){return!mw.message(msg).exists();});if(missing.length===0){return $.Deferred().resolve();}return this.loadMessages(missing,options);}});}());(function(){var saveOptionsRequests={};$.extend(mw.Api.prototype,{saveOption:function(name,value){var param={};param[name]=value;return this.saveOptions(param);},saveOptions:function(options){var name,value,bundleable,grouped=[],promise;if(mw.config.get('wgUserName')===null){return $.Deferred().reject('notloggedin').promise();}if(saveOptionsRequests[this.defaults.ajax.url]&&saveOptionsRequests[this.defaults.ajax.url].state()==='pending'){promise=saveOptionsRequests[this.defaults.ajax.url].then(
function(){return $.Deferred().resolve();},function(){return $.Deferred().resolve();});}else{promise=$.Deferred().resolve();}for(name in options){value=options[name]===null?null:String(options[name]);if(this.defaults.useUS){bundleable=name.indexOf('=')===-1;}else{bundleable=(value===null||value.indexOf('|')===-1)&&(name.indexOf('|')===-1&&name.indexOf('=')===-1);}if(bundleable){if(value!==null){grouped.push(name+'='+value);}else{grouped.push(name);}}else{if(value!==null){promise=promise.then(function(name,value){return this.postWithToken('csrf',{formatversion:2,action:'options',optionname:name,optionvalue:value});}.bind(this,name,value));}else{promise=promise.then(function(name){return this.postWithToken('csrf',{formatversion:2,action:'options',optionname:name});}.bind(this,name));}}}if(grouped.length){promise=promise.then(function(){return this.postWithToken('csrf',{formatversion:2,action:'options',change:grouped});}.bind(this));}saveOptionsRequests[this.defaults.ajax.url]=promise;
return promise;}});}());(function(){$.extend(mw.Api.prototype,{parse:function(content,additionalParams){var apiPromise,config=$.extend({formatversion:2,action:'parse',contentmodel:'wikitext'},additionalParams);if(mw.Title&&content instanceof mw.Title){config.page=content.getPrefixedDb();apiPromise=this.get(config);}else{config.text=String(content);apiPromise=this.post(config);}return apiPromise.then(function(data){return data.parse.text;}).promise({abort:apiPromise.abort});}});}());(function(){$.extend(mw.Api.prototype,{rollback:function(page,user,params){return this.postWithToken('rollback',$.extend({action:'rollback',title:String(page),user:user,uselang:mw.config.get('wgUserLanguage')},params)).then(function(data){return data.rollback;});}});}());(function(){var nonce=0,fieldsAllowed={stash:!0,filekey:!0,filename:!0,comment:!0,text:!0,watchlist:!0,ignorewarnings:!0,chunk:!0,offset:!0,filesize:!0,async:!0};function getNonce(){return nonce++;}function getFirstKey(
obj){var key;for(key in obj){return key;}}function getNewIframe(id){var frame=document.createElement('iframe');frame.id=id;frame.name=id;return frame;}function getHiddenInput(name,val){return $('<input>').attr('type','hidden').attr('name',name).val(val);}function processIframeResult(iframe){var json,doc=iframe.contentDocument||frames[iframe.id].document;if(doc.XMLDocument){return doc.XMLDocument;}if(doc.body){json=$(doc.body).find('pre').text();return JSON.parse(json);}return doc;}function formDataAvailable(){return window.FormData!==undefined&&window.File!==undefined&&window.File.prototype.slice!==undefined;}$.extend(mw.Api.prototype,{upload:function(file,data){var isFileInput,canUseFormData;isFileInput=file&&file.nodeType===Node.ELEMENT_NODE;if(formDataAvailable()&&isFileInput&&file.files){file=file.files[0];}if(!file){throw new Error('No file');}canUseFormData=formDataAvailable()&&(file instanceof window.File||file instanceof window.Blob);if(!isFileInput&&!canUseFormData){throw new Error
('Unsupported argument type passed to mw.Api.upload');}if(canUseFormData){return this.uploadWithFormData(file,data);}return this.uploadWithIframe(file,data);},uploadWithIframe:function(file,data){var key,tokenPromise=$.Deferred(),api=this,deferred=$.Deferred(),nonce=getNonce(),id='uploadframe-'+nonce,$form=$('<form>'),iframe=getNewIframe(id),$iframe=$(iframe);for(key in data){if(!fieldsAllowed[key]){delete data[key];}}data=$.extend({},this.defaults.parameters,{action:'upload'},data);$form.addClass('mw-api-upload-form');$form.css('display','none').attr({action:this.defaults.ajax.url,method:'POST',target:id,enctype:'multipart/form-data'});$iframe.one('load',function(){$iframe.one('load',function(){var result=processIframeResult(iframe);deferred.notify(1);if(!result){deferred.reject('ok-but-empty','No response from API on upload attempt.');}else if(result.error){if(result.error.code==='badtoken'){api.badToken('csrf');}deferred.reject(result.error.code,result);}else if(result.upload&&
result.upload.warnings){deferred.reject(getFirstKey(result.upload.warnings),result);}else{deferred.resolve(result);}});tokenPromise.done(function(){$form.trigger('submit');});});$iframe.on('error',function(error){deferred.reject('http',error);});$iframe.prop('src','about:blank').hide();file.name='file';$.each(data,function(key,val){$form.append(getHiddenInput(key,val));});if(!data.filename&&!data.stash){throw new Error('Filename not included in file data.');}if(this.needToken()){this.getEditToken().then(function(token){$form.append(getHiddenInput('token',token));tokenPromise.resolve();},tokenPromise.reject);}else{tokenPromise.resolve();}$('body').append($form,$iframe);deferred.always(function(){$form.remove();$iframe.remove();});return deferred.promise();},uploadWithFormData:function(file,data){var key,request,deferred=$.Deferred();for(key in data){if(!fieldsAllowed[key]){delete data[key];}}data=$.extend({},this.defaults.parameters,{action:'upload'},data);if(!data.chunk){data.file=file
;}if(!data.filename&&!data.stash){throw new Error('Filename not included in file data.');}request=this[this.needToken()?'postWithEditToken':'post'](data,{contentType:'multipart/form-data',timeout:0,xhr:function(){var xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener('progress',function(ev){if(ev.lengthComputable){deferred.notify(ev.loaded/ev.total);}});}return xhr;}}).done(function(result){deferred.notify(1);if(result.upload&&result.upload.warnings){deferred.reject(getFirstKey(result.upload.warnings),result);}else{deferred.resolve(result);}}).fail(function(errorCode,result){deferred.notify(1);deferred.reject(errorCode,result);});return deferred.promise({abort:request.abort});},chunkedUpload:function(file,data,chunkSize,chunkRetries){var start,end,promise,next,active,deferred=$.Deferred();chunkSize=chunkSize===undefined?5*1024*1024:chunkSize;chunkRetries=chunkRetries===undefined?1:chunkRetries;if(!data.filename){throw new Error('Filename not included in file data.');}
active=promise=this.uploadChunk(file,data,0,chunkSize,'',chunkRetries).done(chunkSize>=file.size?deferred.resolve:null).fail(deferred.reject).progress(deferred.notify);for(start=chunkSize;start<file.size;start+=chunkSize){end=Math.min(start+chunkSize,file.size);next=$.Deferred();promise.done(function(start,end,next,result){var filekey=result.upload.filekey;active=this.uploadChunk(file,data,start,end,filekey,chunkRetries).done(end===file.size?deferred.resolve:next.resolve).fail(deferred.reject).progress(deferred.notify);}.bind(this,start,end,next));promise=next;}return deferred.promise({abort:active.abort});},uploadChunk:function(file,data,start,end,filekey,retries){var upload,api=this,chunk=this.slice(file,start,end);retries=retries===undefined?1:retries;data.filesize=file.size;data.chunk=chunk;data.offset=start;if(filekey&&start!==0){data.filekey=filekey;}upload=this.uploadWithFormData(file,data);return upload.then(null,function(code,result){var retry;if(result.upload&&result.upload.
warnings&&code in result.upload.warnings){if(end===file.size){return $.Deferred().reject(code,result);}else{return $.Deferred().resolve(result);}}if(retries===0){return $.Deferred().reject(code,result);}retry=api.uploadChunk.bind(api,file,data,start,end,filekey,retries-1);return api.retry(code,result,retry);},function(fraction){return(start+fraction*(end-start))/file.size;}).promise({abort:upload.abort});},retry:function(code,result,callable){var uploadPromise,retryTimer,deferred=$.Deferred(),retry=function(){uploadPromise=callable();uploadPromise.then(deferred.resolve,deferred.reject);};if(code!=='http'||result.textStatus==='abort'){return deferred.reject(code,result);}retryTimer=setTimeout(retry,1000);return deferred.promise({abort:function(){if(retryTimer){clearTimeout(retryTimer);}if(uploadPromise.abort){uploadPromise.abort();}}});},slice:function(file,start,stop){if(file.mozSlice){return file.mozSlice(start,stop,file.type);}else if(file.webkitSlice){return file.webkitSlice(start,
stop,file.type);}else{return file.slice(start,stop,file.type);}},finishUploadToStash:function(uploadPromise,data){var filekey,api=this;function finishUpload(moreData){return api.uploadFromStash(filekey,$.extend(data,moreData));}return uploadPromise.then(function(result){filekey=result.upload.filekey;return finishUpload;},function(errorCode,result){if(result&&result.upload&&result.upload.result==='Success'&&result.upload.filekey){filekey=result.upload.filekey;return $.Deferred().resolve(finishUpload);}return $.Deferred().reject(errorCode,result);});},uploadToStash:function(file,data){var promise;if(!data.filename){throw new Error('Filename not included in file data.');}promise=this.upload(file,{stash:!0,filename:data.filename});return this.finishUploadToStash(promise,data);},chunkedUploadToStash:function(file,data,chunkSize,chunkRetries){var promise;if(!data.filename){throw new Error('Filename not included in file data.');}promise=this.chunkedUpload(file,{stash:!0,filename:data.
filename},chunkSize,chunkRetries);return this.finishUploadToStash(promise,data);},uploadFromStash:function(filekey,data){data.filekey=filekey;data.action='upload';data.format='json';if(!data.filename){throw new Error('Filename not included in file data.');}return this.postWithEditToken(data).then(function(result){if(result.upload&&result.upload.warnings){return $.Deferred().reject(getFirstKey(result.upload.warnings),result).promise();}return result;});},needToken:function(){return true;}});}());(function(){$.extend(mw.Api.prototype,{getUserInfo:function(){return this.get({action:'query',meta:'userinfo',uiprop:['groups','rights']}).then(function(data){if(data.query&&data.query.userinfo){return data.query.userinfo;}return $.Deferred().reject().promise();});}});}());(function(){function doWatchInternal(pages,addParams){var apiPromise=this.postWithToken('watch',$.extend({formatversion:2,action:'watch',titles:Array.isArray(pages)?pages:String(pages)},addParams));return apiPromise.then(
function(data){return Array.isArray(pages)?data.watch:data.watch[0];}).promise({abort:apiPromise.abort});}$.extend(mw.Api.prototype,{watch:function(pages){return doWatchInternal.call(this,pages);},unwatch:function(pages){return doWatchInternal.call(this,pages,{unwatch:1});}});}());});